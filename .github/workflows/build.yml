name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  check:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            triplet: x64-linux
          - os: macos-latest
            triplet: arm64-osx

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Cache vcpkg installed packages
      uses: actions/cache@v4
      with:
        path: build/vcpkg_installed
        key: vcpkg-${{ matrix.triplet }}-${{ hashFiles('vcpkg.json') }}

    - name: Configure CMake
      run: cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }} -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release --parallel

    - name: Test binary
      run: ./build/tccp --version

  check-windows:
    runs-on: windows-latest
    continue-on-error: true

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Cache vcpkg installed packages
      uses: actions/cache@v4
      with:
        path: build/vcpkg_installed
        key: vcpkg-x64-windows-static-${{ hashFiles('vcpkg.json') }}

    - name: Configure CMake
      run: cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows-static -DTCCP_STATIC_BUILD=ON -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release --parallel

    - name: Test binary
      run: ./build/Release/tccp.exe --version
      shell: bash
