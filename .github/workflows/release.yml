name: Release

on:
  push:
    branches: [main]
    paths: [releases]

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.ver.outputs.tag }}
      version: ${{ steps.ver.outputs.version }}
      created: ${{ steps.check.outputs.exists == 'false' }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version from releases file
      id: ver
      run: |
        LINE=$(tail -1 releases)
        VERSION=$(echo "$LINE" | cut -d'|' -f1)
        TITLE=$(echo "$LINE" | cut -s -d'|' -f2)
        [ -z "$TITLE" ] && TITLE="Release v$VERSION"
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"
        echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"
        echo "title=$TITLE" >> "$GITHUB_OUTPUT"

    - name: Check if tag exists
      id: check
      run: |
        if git rev-parse "v${{ steps.ver.outputs.version }}" >/dev/null 2>&1; then
          echo "exists=true" >> "$GITHUB_OUTPUT"
        else
          echo "exists=false" >> "$GITHUB_OUTPUT"
        fi

    - name: Create release
      if: steps.check.outputs.exists == 'false'
      run: |
        gh release create "${{ steps.ver.outputs.tag }}" \
          --title "${{ steps.ver.outputs.title }}" \
          --generate-notes
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    needs: create-release
    if: needs.create-release.outputs.created == 'true'
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            triplet: x64-linux
            artifact: tccp-linux-x64
          - os: macos-latest
            triplet: arm64-osx
            artifact: tccp-macos-arm64

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Cache vcpkg installed packages
      uses: actions/cache@v4
      with:
        path: build/vcpkg_installed
        key: vcpkg-${{ matrix.triplet }}-${{ hashFiles('vcpkg.json') }}

    - name: Configure CMake
      run: cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }} -DTCCP_STATIC_BUILD=ON -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release --parallel

    - name: Strip binary
      run: strip build/tccp || true

    - name: Test binary
      run: ./build/tccp --version

    - name: Upload to release
      run: |
        cp build/tccp ${{ matrix.artifact }}
        gh release upload "${{ needs.create-release.outputs.tag }}" "${{ matrix.artifact }}" --clobber
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    needs: create-release
    if: needs.create-release.outputs.created == 'true'
    runs-on: windows-latest
    continue-on-error: true

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Cache vcpkg installed packages
      uses: actions/cache@v4
      with:
        path: build/vcpkg_installed
        key: vcpkg-x64-windows-static-${{ hashFiles('vcpkg.json') }}

    - name: Configure CMake
      run: cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows-static -DTCCP_STATIC_BUILD=ON -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release --parallel

    - name: Test binary
      run: ./build/Release/tccp.exe --version
      shell: bash

    - name: Upload to release
      run: |
        cp build/Release/tccp.exe tccp-windows-x64.exe
        gh release upload "${{ needs.create-release.outputs.tag }}" tccp-windows-x64.exe --clobber
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-tap:
    needs: [create-release, build]
    runs-on: ubuntu-latest
    steps:
    - name: Get release info
      id: release
      run: |
        VERSION="${{ needs.create-release.outputs.version }}"
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"

        MACOS_URL="https://github.com/Seth-Lupo/tccp/releases/download/v${VERSION}/tccp-macos-arm64"
        LINUX_URL="https://github.com/Seth-Lupo/tccp/releases/download/v${VERSION}/tccp-linux-x64"

        curl -fSL -o macos-bin "$MACOS_URL"
        curl -fSL -o linux-bin "$LINUX_URL"

        echo "macos_sha=$(sha256sum macos-bin | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
        echo "linux_sha=$(sha256sum linux-bin | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

    - name: Checkout tap
      uses: actions/checkout@v4
      with:
        repository: Seth-Lupo/homebrew-tap
        token: ${{ secrets.TAP_TOKEN }}

    - name: Update formula
      run: |
        VERSION="${{ steps.release.outputs.version }}"
        MACOS_SHA="${{ steps.release.outputs.macos_sha }}"
        LINUX_SHA="${{ steps.release.outputs.linux_sha }}"

        cat > Formula/tccp.rb << EOF
        class Tccp < Formula
          desc "CLI for running code on HPC clusters"
          homepage "https://seth-lupo.github.io/tccp"
          version "${VERSION}"
          license "MIT"

          on_macos do
            on_arm do
              url "https://github.com/Seth-Lupo/tccp/releases/download/v${VERSION}/tccp-macos-arm64"
              sha256 "${MACOS_SHA}"
            end
          end

          on_linux do
            on_intel do
              url "https://github.com/Seth-Lupo/tccp/releases/download/v${VERSION}/tccp-linux-x64"
              sha256 "${LINUX_SHA}"
            end
          end

          def install
            binary = stable.url.split("/").last
            bin.install binary => "tccp"
          end

          test do
            assert_match "version", shell_output("#{bin}/tccp --version")
          end
        end
        EOF

    - name: Commit and push
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add Formula/tccp.rb
        git commit -m "Update tccp to ${{ steps.release.outputs.version }}"
        git push
