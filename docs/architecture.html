<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>tccp - how it works</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" href="logo.png" type="image/png">
</head>
<body>
<h1>how it works</h1>
<nav>
<a href="index.html">home</a>
<a href="install.html">install</a>
<a href="usage.html">usage</a>
<a href="commands.html">commands</a>
<a href="settings.html">settings</a>
<a href="architecture.html">how it works</a>
<a href="contact.html">contact</a>
</nav>

<h2>the problem</h2>
<p>
Running anything on an HPC cluster usually means writing SLURM batch scripts,
copying files with scp, loading the right modules, pulling containers,
and staring at squeue. On top of that, you're constantly fighting storage:
home directories have tight quotas, container images are multi-gigabyte,
pip and torch caches bloat fast, and scratch space disappears on reboot.
</p>

<h2>the approach</h2>
<svg viewBox="0 0 720 280" xmlns="http://www.w3.org/2000/svg" style="width:100%;max-width:720px;margin:16px 0;">
  <defs>
    <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#c8b896"/>
    </marker>
  </defs>

  <!-- cluster bracket -->
  <line x1="255" y1="25" x2="700" y2="25" stroke="#333" stroke-width="1"/>
  <line x1="255" y1="25" x2="255" y2="32" stroke="#333" stroke-width="1"/>
  <line x1="700" y1="25" x2="700" y2="32" stroke="#333" stroke-width="1"/>
  <text x="478" y="18" text-anchor="middle" fill="#666" font-family="monospace" font-size="10">cluster</text>

  <!-- your laptop -->
  <rect x="20" y="65" width="160" height="80" rx="6" fill="#111" stroke="#d4a857" stroke-width="1.5"/>
  <text x="100" y="98" text-anchor="middle" fill="#d4a857" font-family="monospace" font-size="15" font-weight="bold">tccp</text>
  <text x="100" y="118" text-anchor="middle" fill="#666" font-family="monospace" font-size="11">your laptop</text>

  <!-- DTN -->
  <rect x="270" y="65" width="140" height="80" rx="6" fill="#111" stroke="#6a9fb5" stroke-width="1.5"/>
  <text x="340" y="93" text-anchor="middle" fill="#6a9fb5" font-family="monospace" font-size="15" font-weight="bold">DTN</text>
  <text x="340" y="113" text-anchor="middle" fill="#666" font-family="monospace" font-size="10">file sync, env setup</text>
  <text x="340" y="127" text-anchor="middle" fill="#666" font-family="monospace" font-size="10">port forwarding</text>

  <!-- login node -->
  <rect x="530" y="185" width="160" height="70" rx="6" fill="#111" stroke="#6a9fb5" stroke-width="1.5"/>
  <text x="610" y="215" text-anchor="middle" fill="#6a9fb5" font-family="monospace" font-size="14" font-weight="bold">login</text>
  <text x="610" y="235" text-anchor="middle" fill="#666" font-family="monospace" font-size="10">salloc, squeue, scancel</text>

  <!-- compute node -->
  <rect x="530" y="65" width="160" height="80" rx="6" fill="#111" stroke="#6a9fb5" stroke-width="1.5"/>
  <text x="610" y="93" text-anchor="middle" fill="#6a9fb5" font-family="monospace" font-size="15" font-weight="bold">compute</text>
  <text x="610" y="113" text-anchor="middle" fill="#666" font-family="monospace" font-size="10">your code runs here</text>
  <text x="610" y="127" text-anchor="middle" fill="#666" font-family="monospace" font-size="10">GPU, large /tmp</text>

  <!-- laptop -> DTN -->
  <line x1="180" y1="105" x2="265" y2="105" stroke="#c8b896" stroke-width="1.5" marker-end="url(#arrow)"/>
  <text x="223" y="96" text-anchor="middle" fill="#c8b896" font-family="monospace" font-size="11">SSH</text>
  <text x="223" y="125" text-anchor="middle" fill="#666" font-family="monospace" font-size="9">1 session</text>

  <!-- DTN -> compute -->
  <line x1="410" y1="105" x2="525" y2="105" stroke="#c8b896" stroke-width="1.5" marker-end="url(#arrow)"/>
  <text x="468" y="96" text-anchor="middle" fill="#c8b896" font-family="monospace" font-size="10">SSH hop</text>

  <!-- DTN -> login -->
  <line x1="410" y1="135" x2="525" y2="205" stroke="#c8b896" stroke-width="1.5" marker-end="url(#arrow)"/>
  <text x="448" y="175" fill="#c8b896" font-family="monospace" font-size="10">SSH hop</text>

  <!-- multiplexed note -->
  <line x1="60" y1="260" x2="650" y2="260" stroke="#222" stroke-width="1" stroke-dasharray="4,4"/>
  <text x="355" y="275" text-anchor="middle" fill="#666" font-family="monospace" font-size="10">everything multiplexed on one connection to DTN</text>
</svg>
<p>
tccp opens a single SSH session to the data transfer node (DTN). Everything
goes through that one connection. The DTN handles file sync, environment
setup, and port forwarding. For SLURM commands (allocating nodes, checking
job status, canceling), tccp hops through the DTN to the login node.
For actually running your code, it hops to the compute node.
</p>
<p>
Compute nodes don't accept external SSH keys, so all access goes through
the DTN using cluster-internal auth. Port forwarding uses SSH protocol-level
<code>direct-tcpip</code> channels, which don't need any extra authentication.
</p>

<h2>storage strategy</h2>
<p>
The cluster has three kinds of storage, each with different tradeoffs.
tccp puts things in the right place automatically:
</p>
<table>
<tr><th>location</th><th>properties</th><th>what tccp puts there</th></tr>
<tr>
<td>NFS home (~/) </td>
<td>Persistent, small quota (5-30GB), visible from all nodes</td>
<td>Container images (cached .sif files), virtualenvs, job output</td>
</tr>
<tr>
<td>Compute /tmp</td>
<td>Fast local disk, large (hundreds of GB), wiped on reboot</td>
<td>Synced code, pip/torch/HF caches, runtime temp files</td>
</tr>
<tr>
<td>Shared cache (/tmp/{user}/{project}/.tccp-cache)</td>
<td>Persists across jobs on the same node</td>
<td>Downloaded datasets, model checkpoints (the <code>cache:</code> dir)</td>
</tr>
</table>
<p>
Container pulls are the biggest storage challenge. OCI blobs and SIF
conversion can need ~12GB of temp space &mdash; more than most DTN /tmp
partitions and way over home dir quotas. So tccp pulls containers on the
compute node (which has a large /tmp), then stores the final .sif on NFS
where it's visible everywhere. The temp files are cleaned up in the same
command.
</p>
<p>
All runtime caches (pip, torch, HuggingFace, XDG) are redirected to
compute node /tmp so they never touch your home quota. If a node reboots
and /tmp is wiped, tccp detects the missing scratch and does a fresh sync
automatically.
</p>

<h2>what happens when you type <code>run train</code></h2>
<ol>
<li><b>Allocate</b> &mdash; tccp asks the login node for a SLURM allocation, or reuses an idle one.</li>
<li><b>Environment</b> &mdash; checks if the container, venv, and dtach are set up. Pulls or builds whatever's missing. Container pull happens on the compute node to avoid quota issues.</li>
<li><b>Sync</b> &mdash; tars up your local code and pipes it through SSH to the compute node's scratch dir. Only sends files that changed since the last sync.</li>
<li><b>Launch</b> &mdash; generates a run script, copies it to the node, and starts it under dtach.</li>
<li><b>Attach</b> &mdash; connects to the dtach socket and streams the job output to your terminal.</li>
</ol>
<p>All of this happens in a background thread, so you can keep using the REPL
while the job initializes.</p>

<h2>where things live</h2>

<svg viewBox="0 0 720 380" xmlns="http://www.w3.org/2000/svg" style="width:100%;max-width:720px;margin:16px 0;">
  <!-- NFS box -->
  <rect x="10" y="10" width="340" height="280" rx="8" fill="#111" stroke="#d4a857" stroke-width="1.5"/>
  <text x="24" y="34" fill="#d4a857" font-family="monospace" font-size="13" font-weight="bold">NFS home (~/)</text>
  <text x="24" y="50" fill="#666" font-family="monospace" font-size="10">persistent, quota-limited, all nodes</text>

  <text x="30" y="74" fill="#6a9fb5" font-family="monospace" font-size="11">tccp/</text>
  <text x="50" y="92" fill="#c8b896" font-family="monospace" font-size="10">bin/dtach</text>
  <text x="190" y="92" fill="#666" font-family="monospace" font-size="9">built on first use</text>
  <text x="50" y="110" fill="#6a9fb5" font-family="monospace" font-size="10">container-cache/</text>
  <text x="50" y="126" fill="#c8b896" font-family="monospace" font-size="10">  images/*.sif</text>
  <text x="190" y="126" fill="#666" font-family="monospace" font-size="9">containers (LRU managed)</text>

  <text x="50" y="150" fill="#6a9fb5" font-family="monospace" font-size="10">projects/{name}/</text>
  <text x="70" y="168" fill="#c8b896" font-family="monospace" font-size="10">env/default/venv/</text>
  <text x="210" y="168" fill="#666" font-family="monospace" font-size="9">persistent virtualenv</text>
  <text x="70" y="186" fill="#c8b896" font-family="monospace" font-size="10">output/{job_id}/</text>
  <text x="210" y="186" fill="#666" font-family="monospace" font-size="9">synced back to laptop</text>

  <!-- Compute box â€” same height -->
  <rect x="370" y="10" width="340" height="280" rx="8" fill="#111" stroke="#6a9fb5" stroke-width="1.5"/>
  <text x="384" y="34" fill="#6a9fb5" font-family="monospace" font-size="13" font-weight="bold">Compute /tmp/{user}/</text>
  <text x="384" y="50" fill="#666" font-family="monospace" font-size="10">fast, large, wiped on reboot</text>

  <text x="390" y="74" fill="#6a9fb5" font-family="monospace" font-size="11">{project}/{job_id}/</text>

  <text x="410" y="92" fill="#c8b896" font-family="monospace" font-size="10">(your code)</text>
  <text x="550" y="92" fill="#666" font-family="monospace" font-size="9">scratch copy</text>

  <text x="410" y="110" fill="#c8b896" font-family="monospace" font-size="10">cache/</text>
  <text x="550" y="110" fill="#666" font-family="monospace" font-size="9">bind-mounted cache</text>

  <text x="410" y="128" fill="#c8b896" font-family="monospace" font-size="10">output/</text>
  <text x="550" y="128" fill="#666" font-family="monospace" font-size="9">symlink to NFS</text>

  <text x="410" y="146" fill="#c8b896" font-family="monospace" font-size="10">tccp_run.sh</text>
  <text x="550" y="146" fill="#666" font-family="monospace" font-size="9">generated run script</text>

  <text x="410" y="164" fill="#c8b896" font-family="monospace" font-size="10">tccp.log</text>
  <text x="550" y="164" fill="#666" font-family="monospace" font-size="9">job output log</text>

  <text x="410" y="182" fill="#c8b896" font-family="monospace" font-size="10">tccp.sock</text>
  <text x="550" y="182" fill="#666" font-family="monospace" font-size="9">dtach socket</text>

  <text x="390" y="210" fill="#6a9fb5" font-family="monospace" font-size="11">{project}/.tccp-cache/</text>
  <text x="410" y="226" fill="#666" font-family="monospace" font-size="9">persists across jobs on same node</text>

  <text x="390" y="250" fill="#6a9fb5" font-family="monospace" font-size="11">singularity-cache/</text>
  <text x="410" y="266" fill="#666" font-family="monospace" font-size="9">temp during pull, cleaned up after</text>

  <!-- legend row below both boxes -->
  <rect x="10" y="310" width="12" height="12" rx="2" fill="none" stroke="#d4a857" stroke-width="1.5"/>
  <text x="28" y="321" fill="#666" font-family="monospace" font-size="10">persistent (NFS)</text>

  <rect x="170" y="310" width="12" height="12" rx="2" fill="none" stroke="#6a9fb5" stroke-width="1.5"/>
  <text x="188" y="321" fill="#666" font-family="monospace" font-size="10">ephemeral (local /tmp)</text>

  <text x="370" y="321" fill="#6a9fb5" font-family="monospace" font-size="10">directory/</text>
  <text x="440" y="321" fill="#c8b896" font-family="monospace" font-size="10">file</text>
  <text x="475" y="321" fill="#666" font-family="monospace" font-size="10">description</text>
</svg>

<h2>job lifecycle</h2>

<svg viewBox="0 0 720 80" xmlns="http://www.w3.org/2000/svg" style="width:100%;max-width:720px;margin:16px 0;">
  <line x1="20" y1="30" x2="700" y2="30" stroke="#333" stroke-width="2"/>
  <circle cx="60" cy="30" r="5" fill="#d4a857"/>
  <text x="60" y="55" text-anchor="middle" fill="#c8b896" font-family="monospace" font-size="10">submit</text>
  <circle cx="200" cy="30" r="5" fill="#6a9fb5"/>
  <text x="200" y="55" text-anchor="middle" fill="#c8b896" font-family="monospace" font-size="10">running</text>
  <text x="200" y="70" text-anchor="middle" fill="#666" font-family="monospace" font-size="9">attach/detach freely</text>
  <circle cx="400" cy="30" r="5" fill="#6a9fb5"/>
  <text x="400" y="55" text-anchor="middle" fill="#c8b896" font-family="monospace" font-size="10">completed</text>
  <text x="400" y="70" text-anchor="middle" fill="#666" font-family="monospace" font-size="9">detected ~1s</text>
  <circle cx="560" cy="30" r="5" fill="#d4a857"/>
  <text x="560" y="55" text-anchor="middle" fill="#c8b896" font-family="monospace" font-size="10">output returned</text>
  <text x="560" y="70" text-anchor="middle" fill="#666" font-family="monospace" font-size="9">auto-downloaded</text>
  <line x1="60" y1="30" x2="200" y2="30" stroke="#d4a857" stroke-width="2"/>
  <line x1="200" y1="30" x2="400" y2="30" stroke="#6a9fb5" stroke-width="2"/>
  <line x1="400" y1="30" x2="560" y2="30" stroke="#d4a857" stroke-width="2"/>
  <circle cx="680" cy="30" r="5" fill="#333" stroke="#666" stroke-width="1"/>
  <text x="680" y="55" text-anchor="middle" fill="#666" font-family="monospace" font-size="9">alloc idle</text>
  <text x="680" y="70" text-anchor="middle" fill="#666" font-family="monospace" font-size="9">(reusable)</text>
</svg>

<p>
Jobs run under <b>dtach</b>, so they survive disconnects, laptop sleep,
and WiFi drops. <code>view</code> attaches to the live output,
<code>Ctrl+C</code> detaches &mdash; reattach anytime. A background
watcher on the DTN monitors the dtach socket and detects completion
within about a second. Output is downloaded automatically when a job
finishes; if you're offline, it downloads next time you connect.
</p>
<p>
Allocations stay alive after jobs end, so the next <code>run</code> with
compatible resources reuses the existing node instantly &mdash; no queue
wait, no environment setup, just sync and launch. When you exit tccp,
any idle allocations (no running jobs) are released automatically so
you don't burn SUs by accident.
</p>

</body>
</html>
